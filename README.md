# ModbusJS
## Overview
Modbus communication library for NodeJS using promises. 
## Status
The library is still under active development and i keep adding functionality as well as possibly changing already implemented functionality if required. However i'll try to keep already implemented and working interfaces unchanged.

Currently implemented and working functionality :

*   ModbusTcpClient - Modbus client (master) for communication over TCP 
    *   readCoils
    *   readDiscreteInputs
    *   readHoldingRegisters
    *   readInputRegisters
    *   writeSingleCoil
    *   writeSingleRegister
    *   writeMultipleCoils
    *   writeMultipleCoilsSameValue

## Installation
```javascript
npm install modbusjs
```
## Usage
ModbusJS is using ES6 Promises (thus no 3rd party promise module dependency). EventEmitter is also used to emit instance (ie. connection) related events, see below.
### ModbusTcpClient
```javascript
var ModbusTcpClient = require('modbusjs').ModbusTcpClient;
```
#### constructor

Returns a new instance of ModbusTcpClient. Connection is not established at this point.

**function(host, port[,options])**

*   host: IP address or DNS name of modbus server
*   port: Port of modbus server (usually 502)
*   options: Optional
    *   debug: Turn on debugging messages printed out to console. Default value is FALSE

**example**
```javascript
var modbusTcpClient = new ModbusTcpClient('localhost', 502, {debug: true})
```

#### connect

Tries to establish communication with a target modbus server specified during the initialization. In case
of error returns Error object generated by nodejs socket.

**example**

```javascript
modbusTcpClient.connect().then(function(){
    // Connected
}).catch(function(err){
    // Error
});
```

#### disconnect

Destroys socket connection to the modbus server. If there is no active connection returns an error.

**example**

```javascript
modbusTcpClient.disconnect().then(function(){
    // Disconnected
}).catch(function(err){
    // No active connection
});
```

#### readCoils

Reads coils from the modbus server (only if connection is active otherwise returns error). Maximum number of coils
which can be read in one transaction is 2000.

**function(address, length[,options])**

*   address: Starting coil address
*   length: Number of coils to read
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.
If request is successful then result is returned with following attributes
*   result: Array of booleans
*   request: Request object
*   response: Response object

**example**

```javascript
modbusTcpClient.readCoils(0, 10).then(function(result){
    // Success
}).catch(function(err){
    // Error
});
```

#### readDiscreteInputs

Reads inputs from the modbus server. Same interface and return values as *readCoils*.

**example**

```javascript
modbusTcpClient.readDiscreteInputs(0, 10).then(function(result){
    /// Success
}).catch(function(err){
    // Error
});
```

#### readHoldingRegisters

Reads holding registers from modbus server. Maximum number of registers which can be read in one transaction is 125.

**function(address, length[,options])**

*   address: Starting register address
*   length: Number of registers to read
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.
    *   unsigned: By default all the results are converted as signed. If this options is TRUE then unsigned will be used instead.
If request is successful then result is returned with following attributes
*   result: Array of (U)Int16
*   request: Request object
*   response: Response object

**example**

```javascript
modbusTcpClient.readHoldingRegisters(0, 10).then(function(result){
    // Success
}).catch(function(err){
    // Error
});
```

#### readInputgRegisters

Reads inputs from the modbus server. Same interface and return values as *readHoldingRegisters*.

**example**

```javascript
modbusTcpClient.readInputgRegisters(0, 10).then(function(result){
    // Success
}).catch(function(err){
    // Error
});
```

#### writeSingleCoil

Writes single coil value. 

**function(address, value[,options])**

*   address: Coil address
*   value: Value to be written. Can be either true/false or 0/1 - Otherwise an error is returned.
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.

If request is successful then result is returned with following attributes
*   result: Echoed value from the request
*   request: Request object
*   response: Response object

**example**

```javascript
mtcp.writeSingleCoil(6, 0).then(function(res){
    // Success
}).catch(function(err){
    // Error
})
```

#### writeSingleRegister

Writes single register value. 

**function(address, value[,options])**

*   address: Register address
*   value: Value to be written. Maximum value is 0xFFFF.
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.

If request is successful then result is returned with following attributes
*   result: Echoed value from the request
*   request: Request object
*   response: Response object

**example**

```javascript
mtcp.writeSingleRegister(1, 123).then(function(res){
    // Success
}).catch(function(err){
    // Error
})
```

#### writeMultipleCoils

Writes multiple coils in one transaction to the target modbus server.

**function(address, values[,options])**

*   address: Starting coil address
*   values: Array of booleans to be written to the server starting from starting address.
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.

If request is successful then result is returned with following attributes
*   result: Number of output coils
*   request: Request object
*   response: Response object

**example**

```javascript
mtcp.writeMultipleCoils(1, [true, false, false, true, 0, 0, 1]).then(function(res){
    // Success
}).catch(function(err){
    // Error
})
```

#### writeMultipleCoilsSameValue

Just a helper with same functionality as *writeMultipleCoils* providing function for cases when the value is same for the 
whole bulk of coils.

**function(address, length, value[,options])**

*   address: Starting coil address
*   length: Number of coils affected
*   value: Boolean value to be written to address + length.
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.

If request is successful then result is returned with following attributes
*   result: Number of output coils
*   request: Request object
*   response: Response object

**example**

```javascript
mtcp.writeMultipleCoilsSameValue(1, 20, true).then(function(res){
    // Success
}).catch(function(err){
    // Error
})
```

#### Events

No events are used for individual transactions. On events affecting whole Modbus instance are emitted.

##### connect

Emitted when connected to the modbus server.

```javascript
modbusTcpClient.on('connect', function(err){
    console.log('CONNECTED - EVENT');
});
```

##### error

Emitted when error occurs.

```javascript
modbusTcpClient.on('error', function(err){
    console.log('ERROR - ' + err);
});
```

##### disconnect

Emitted when disconnected from the modbus server.

```javascript
modbusTcpClient.on('disconnect', function(){
    console.log('DISCONNECTED - EVENT');
});
```

#### Examples

```javascript
var ModbusTcpClient = require('../index').ModbusTcpClient;

var modbusTcpClient = new ModbusTcpClient('192.168.146.2', 502, {debug: true});

modbusTcpClient.on('connect', function(err){
    console.log('CONNECTED - EVENT');
});

modbusTcpClient.on('error', function(err){
    console.log('ERROR - ' + err);
});

modbusTcpClient.on('disconnect', function(){
    console.log('DISCONNECTED - EVENT');
});

modbusTcpClient.connect().then(function(){
    var promises = [];
    promises.push(modbusTcpClient.readCoils(0, 10));
    promises.push(modbusTcpClient.readInputs(0, 10));
    promises.push(modbusTcpClient.readHoldingRegisters(290, 30));
    promises.push(modbusTcpClient.readHoldingRegisters(290, 30, {unsigned: true}));
    promises.push(modbusTcpClient.readInputgRegisters(0, 15));
    Promise.all(promises).then(function(results){
        results.forEach(function(result){
            console.log(result);
        });
        exit();
    }).catch(function(err){
        console.log(err);
        exit();
    });
}).catch(function(err){
    console.log(err);
    exit();
});

function exit() {
    modbusTcpClient.disconnect().then(function(){
        console.log('DISCONNECTED - PROMISED');
    }).catch(function(err){
        console.log(err);
    });
}
```
