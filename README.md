# ModbusJS
## Overview
Modbus communication library for NodeJ using promises. 
## Status
The library is still under active development and i keep adding functionality as well as possibly changing already implented functionality
if required.

Currently implemented and working functionality :

*   ModbusTcpClient - Modbus client (master) for communication over TCP 
    *   readCoils
    *   readInputs
    *   readHoldingRegisters
    *   readInputRegisters
    
## Usage
ModbusJS is using ES6 Promises (thus no 3rd party promise module dependency) as well as inherits from EventEmitter.
### ModbusTcpClient
```javascript
var ModbusTcpClient = require('modbusjs').ModbusTcpClient;
```
#### constructor

Returns a new instance of ModbusTcpClient. Connection is not established at this point.

**function(host, port[,options])**

*   host: IP address or DNS name of modbus server
*   port: Port of modbus server (usually 502)
*   options: Optional
    *   debug: Turn on debugging messages printed out to console, default FALSE
    
**example**
```javascript
var modbusTcpClient = new ModbusTcpClient('localhost', 502, {debug: true})
```
#### connect

Tries to establish communication with target modbus server specified during initialization. Function has no arguments. In case
of error returns Error object generated by socket.
    
**example**
```javascript
modbusTcpClient.connect().then(function(){
    // Connected
}).catch(function(err){
    // Error handling
});
```
#### disconnect

Destroys socket connection to the modbus server. If there is no active connection returns error.
    
**example**
```javascript
modbusTcpClient.disconnect().then(function(){
    // Disconnected
}).catch(function(err){
    // No active connection
});
```
#### readCoils

Read coils from the modbus server (only if connection is active otherwise returns error). Maximum number of coils
which can be read in one transaction is 2000.
    
**function(address, length[,options])**

*   address: Starting coil address
*   length: Number of coils to read
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.
    
If request is successful then result is returned with following attributes
    
*   data: Array of booleans
*   request: Request object
*   response: Response object
    
**example**
```javascript
modbusTcpClient.readCoils(0, 10).then(function(result){
    console.log(result.data)
    console.log(result.request)
    console.log(result.response)
    // Process result
}).catch(function(err){
    // An error has occurred
});
```
#### readInputs

Reads inputs from the modbus server. Input arguments as well as resulting object is same as for *readCoils*.
    
**example**
```javascript
modbusTcpClient.readInputs(0, 10).then(function(result){
    // Process result
}).catch(function(err){
    // An error has occurred
});
```
#### readHoldingRegisters

Reads holding registers from modbus server. Maximum number of registers which can be read in one transaction is 125.
    
**function(address, length[,options])**

*   address: Starting register address
*   length: Number of registers to read
*   options: Optional
    *   timeout: Request timeout. Default is 5 seconds.
    *   unsigned: By default all the results are converted as signed. If this options is TRUE then unsigned will be used instead.
    
If request is successful then result is returned with following attributes
    
*   data: Array of (U)Int16
*   request: Request object
*   response: Response object
    
**example**
```javascript
modbusTcpClient.readHoldingRegisters(0, 10).then(function(result){
    console.log(result.data)
    console.log(result.request)
    console.log(result.response)
    // Process result
}).catch(function(err){
    // An error has occurred
});
```
#### readInputgRegisters

Reads input registers from the modbus server. Input arguments as well as resulting object is same as for *readHoldingRegisters*.
    
**example**
```javascript
modbusTcpClient.readInputgRegisters(0, 10).then(function(result){
    console.log(result.data)
    console.log(result.request)
    console.log(result.response)
    // Process result
}).catch(function(err){
    // An error has occurred
});
```

### Events

No events are used for individual transactions. On events affecting whole Modbus instance are emitted.

#### connect

Emitted when connected to the modbus server.

```javascript
modbusTcpClient.on('connect', function(err){
    console.log('CONNECTED - EVENT');
});
```

#### error

Emitted when error occurs.

```javascript
modbusTcpClient.on('error', function(err){
    console.log('ERROR - ' + err);
});
```

#### disconnect

Emitted when disconnected from the modbus server.

```javascript
modbusTcpClient.on('disconnect', function(){
    console.log('DISCONNECTED - EVENT');
});
```

## Example
```javascript
var ModbusTcpClient = require('../index').ModbusTcpClient;

var modbusTcpClient = new ModbusTcpClient('192.168.146.2', 502, {debug: true});

modbusTcpClient.on('connect', function(err){
    console.log('CONNECTED - EVENT');
});

modbusTcpClient.on('error', function(err){
    console.log('ERROR - ' + err);
});

modbusTcpClient.on('disconnect', function(){
    console.log('DISCONNECTED - EVENT');
});

modbusTcpClient.connect().then(function(){
    var promises = [];
    promises.push(modbusTcpClient.readCoils(0, 10));
    promises.push(modbusTcpClient.readInputs(0, 10));
    promises.push(modbusTcpClient.readHoldingRegisters(290, 30));
    promises.push(modbusTcpClient.readHoldingRegisters(290, 30, {unsigned: true}));
    promises.push(modbusTcpClient.readInputgRegisters(0, 15));
    Promise.all(promises).then(function(results){
        results.forEach(function(result){
            console.log(result);
        });
        exit();
    }).catch(function(err){
        console.log(err);
        exit();
    });
}).catch(function(err){
    console.log(err);
    exit();
});

function exit() {
    modbusTcpClient.disconnect().then(function(){
        console.log('DISCONNECTED - PROMISED');
    }).catch(function(err){
        console.log(err);
    });
}
```